Logline
=======

[![Build Status][travis-image]][travis-url]

logline是一个轻量，实用和用户级的前端日志记录工具。

为何前端定位问题很困难
-----------------
前端同学对此肯定深有体会，代码发出去之后，犹如脱缰的野马，运行在万千的客户终端上，等到产品和后台反馈问题到我们这边，很多时候定位问题只能靠猜，尤其是一些偶发诱因，因为根本不知道用户是如何操作的、随机因素的生成结果，因此很难回放用户的操作来还原现场找到原因。这个时候，我们想，如果有一个像后台一样详实的可分类和检索的运行日志，无疑将会提供巨大的帮助。

<!--more-->

***一个健壮的日志系统大致包含日志记录、日志上传和日志分析三个主要部分，在这次的实践中，我们对这三方面都有所探索。***


记录日志
-------

### 日志存哪里，四种方案选型

由于前端受到很多限制，不能同APP一样可以在文件沙箱内存取文件，因此如何持久化的存储日志成了一个问题。目前H5也支持若干种本地存储方案，cookie, localStorage, indexedDB和websql等，其他的由插件提供的能力不在考虑的范围之类，如flash，移动端的可用性会是一个很大的问题。

+ #### Cookie
	不用想，应该没有人会考虑吧, Cookie的原则应该是尽可能的精简。

+ #### localStorage
	localStorage大家应该都很熟悉，一个简单的键值存储系统，接口简单实用，兼容性也非常的棒。但是考虑到目前很多项目都有使用localStorage来做缓存，而localStorage本身是有大小限制的。根据日志记录的细粒度，很可能会产生较多的日志内容，如果也记录在localStorage里，可能会有超出容量限制的风险。因此，localStorage应该作为一个备用的持久化方案。

+ #### websql
	websql作为一项W3C标准，目前已经被废弃，但是各大桌面浏览器和移动端浏览器都有很好的实现这个接口，兼容性问题不大。估计在下述的indexedDB被很好的支持之前都会一直存在。而各大浏览器实现websql的底层基本上都是sqlite（正是因为这样，作为一个web标准是不可接受的）。因而日志作为大量的结构化数据，应用场景非常的适合。经测试，在iOS上容量最大支持50MB，不过如果使用系统自带的safari，超过5MB时，会主动提醒用户是否要增加数据库的大小，不是很友好，不过微信里到是不会。想想5MB独占作为日志存储基本上够用了，处理好过旧日志的清理工作即可。
	
+ #### indexedDB
	websql废弃之后，indexedDB作为一个替代方案被标准化，然而目前基本没几个浏览器支持，所以不予考虑。未来兼容性完善之后应当替代websql作为主要的方案。
	
### 构建结构和可读性良好的日志

+ **时间戳**，这个无需多说，时间戳是日志的基本要义。
+ **首先日志要支持基本的错误等级**，如 `info`, `warning`, `error`, `critical` 等，以提供最为基本的过滤能力。
+ **提供一个简短的描述符**，如 `verify.request.start`, `submit.prevented` 等等。以便用户一眼就可以知晓日志的大致内容，也方便代码中日志记录代码的可读性，也更易于在代码中搜索。此外，*`还要顺便记录相关数据`*，以便回放相关的场景。
+ **要支持多个会话**，一个前端工程中可能同时存在多个独立的模块，这些模块很可能会同时记录日志。如果每个模块都在自己的会话下记录日志，就不会相互干扰，并且提供了另一个维度的过滤能力。

### 简单友好的API

我们一直这样认为，一个好的库和模块，应该有着一套命名友好、可预测的API接口，并保持向下兼容。因此我们在接口的设计上有着认真的思考。

#### 快速上手

##### 引入脚本

``` javascript
// AMD/CMD
// 使用websql协议
var Logcat = require('./mod/logcat').using('websql');

// Script Tag
<script src="./mod/logcat.js"></script>
<script>
	// 使用localStorage协议
	Logcat.using('localstorage');
</script>
```
	
##### 配置上传地址

``` javascript
Logcat.reportTo('https://hostname.com/cgi-bin/weblog.cgi');
```
	
##### 清理日志

``` javascript
Logcat.keep(.5); // 保留半天以内的日志，如果不传参则清空日志
Logcat.clean(); // 清空日志并删除数据库
```
	
##### 记录日志

``` javascript
// 不同的模块使用不同的日志会话
var spaLog = Logcat('spa'),
	sdkLog = Logcat('sdk');
	
// 不包含数据的，描述为 init.succeed 的记录
spaLog.info('init.succeed');
	
// 包含错误描述数据，描述为 init.failed 的记录
spaLog.error('init.failed', {
	retcode: 'EINIT',
	retmsg: 'invalid signature'
});
	
// 不包含数据的，描述为 outdated 的记录
sdkLog.warning('outdated');
	
// 包含错误描述数据，描述为 system.vanish 的记录
sdkLog.critical('system.vanish', {
    // debug infos here
});
```

##### 上传日志

``` javascript
Logcat.deploy(
	function ticker(percentage) {
		console.log('已上传' + percentage + '%');
	},
	function successHandler() {
		alert('上传成功');
	},
	function errorHandler() {
		alert('上传失败');
	}
);
```

日志上传
------
由于日志是存储在客户端本地的，因此我们需要后台配合开发一个用于接收客户端通过ajax上传的日志内容并存储起来的接口。同时可能要考虑一些安全性问题，如引入token机制等等。目前我们微证券采用的方案为：用户在微信公众号中发送消息“日志上报”，后台返回一个包含token的url地址，用户点击链接进入后，自动上报日志。也可以和后端配合，在cgi返回中通过某个字段触发自动上报。

### 特性支持

+ 基本的日志记录功能
+ 命名空间
+ websql/localStorage两种存储方案
+ 日志等级分类
+ 日志清理
+ 日志上传
+ 无外部依赖
+ 用户级，针对单个用户的分析

### 适用场景

非实时监控日志，适用于在知道用户出现问题后定位问题使用。

日志分析
------
由于Logcat对上传的日志格式做了一定的优化，符合Unix标准日志规范具有良好的可阅读性，因此我们可以在某种程度上直接使用Unix的工具或者编辑器来阅读。但是对类Unix系统不熟悉的用户使用可能仍然有困难，因此有必要使用Web技术栈搭建一个易于使用并且视觉良好的工具。我们希望这套工具可以不依赖与后端，既可以部署在服务器端，也可以当做本地网页直接双击打开，也可以被简单的包一层外壳而当做桌面APP来使用。作为日志，承载的最主要的内容便是大量的纯文本，在调研了一些方案后，我们认为H5规范中的FileReader.readAsText可以很好的做到这一点，结合拖放事件，我们便可以很大致构建出一个不错的方案：用户将一个或者多个日志文件拖放至网页中，即可对这些日志批量分析和检索。

我们构建了一个仅供体验的版本可以在这里访问到 [http://logcat.oa.com]()。

开源
----
我们相信前端的社区应该是开放和合作的，因此我们以MIT协议开源这一套解决方案：

+ 日志记录和上报模块 logline
+ 日志统一上报和分析平台 logmagic

未来规划
------
在这次的实践中，我们有意保持模块的独立性，并没有使用任何外部依赖，因此很容易复用到别的业务或者绑定自己的业务逻辑。不过在未来，我们更喜欢Logcat作为前端日志的一整套解决方案提供，而无需业务在上传和分析部分要做出自己的实现。

更为可用的应用场景应该是业务放在我们的平台上申请一个appid，然后使用我们的统计脚本，所以日志将统一上报到我们的平台，业务方可以使用此appid在我们的系统中浏览、分析和检索所需的日志。


[travis-image]: https://api.travis-ci.org/latel/logline.svg
[travis-url]: https://travis-ci.org/latel/logline