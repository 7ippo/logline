!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Logline=t()}(this,function(){"use strict";function e(e){return e?d[e]:d}function t(e,t){var o={};"string"==typeof e?o[e]=t:"[object Object]"===Object.prototype.toString.call(e)&&(o=e),s(d,o)}function o(e){g&&console.error("Logline: "+e)}function n(e,t,o,n){g&&_.get().verbose&&window.console[y[t.toUpperCase()]||y.INFO](e+" "+t.toUpperCase()+" "+o,n||"")}function r(e){var t,o={};if("object"!==(void 0===e?"undefined":a(e)))return e;for(t in e)e.hasOwnProperty(t)&&"function"!=typeof e[t]&&(o[t]=r(e[t]));return o}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},c=function(){function e(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,o,n){return o&&e(t.prototype,o),n&&e(t,n),t}}(),s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e},u=function e(t,o,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,o);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,o,n)}if("value"in r)return r.value;var i=r.get;if(void 0!==i)return i.call(n)},l=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},f=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},p={verbose:!0},d=s({},p),_=t;_.set=t,_.get=e;var g=window.console,y={INFO:"log",WARN:"warn",ERROR:"error",CRITICAL:"error"},v=function(){function e(t){i(this,e),this._namespace=t}return c(e,[{key:"_record",value:function(e,t,n){o("method _record is not implemented.")}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];this._record.apply(this,["info"].concat(t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];this._record.apply(this,["warn"].concat(t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];this._record.apply(this,["error"].concat(t))}},{key:"critical",value:function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];this._record.apply(this,["critical"].concat(t))}}],[{key:"init",value:function(e){return!0}},{key:"transTimeFormat",value:function(e,t){if(!e||/^\d{13}$/.test(e))return+e;if(t&&!/^\d{13}$/.test(t))throw new TypeError("relative time should be standard unix timestamp");return(t||Date.now())-24*e.replace(/d$/,"")*3600*1e3}},{key:"get",value:function(e,t,n){o("method get is not implemented.")}},{key:"keep",value:function(e){o("method keep is not implemented.")}},{key:"clean",value:function(){o("method clean is not implemented.")}},{key:"STATUS",get:function(){return{INITING:1,INITED:2,FAILED:4}}}]),e}(),h=function(){function e(){i(this,e),this._pool=[]}return c(e,[{key:"push",value:function(e,t){e.context=t,this._pool.push(e)}},{key:"consume",value:function(){for(var e;e=this._pool.shift();)e.call(e.context)}}]),e}(),m=function(e){function t(){var e;i(this,t);for(var o=arguments.length,n=Array(o),r=0;r<o;r++)n[r]=arguments[r];return f(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(n)))}return l(t,e),c(t,[{key:"_record",value:function(e,a,i){var c=this;try{if(t.status!==v.STATUS.INITED)return t._pool.push(function(){return c._record(e,a,i)}),void(t.status!==v.STATUS.INITING&&t.init());n(this._namespace,e,a,i);var s=t.db.transaction(["logs"],IDBTransaction.READ_WRITE||"readwrite");s.onerror=function(e){return o(e.target.error)};s.objectStore("logs").add({time:Date.now(),level:e,namespace:this._namespace,descriptor:a,data:r(i)}).onerror=function(e){t.status=v.STATUS.FAILED,o(e.target.error)}}catch(e){o("failed to write, "+e.message)}}}],[{key:"init",value:function(e){var n=this;try{if(t.support||o("your platform does not support indexeddb protocol."),t.status)return!1;t._pool=t._pool||new h,t._database=e||"logline",t.status=u(t.__proto__||Object.getPrototypeOf(t),"STATUS",this).INITING,t.request=window.indexedDB.open(t._database),t.request.onerror=function(e){return o("protocol indexeddb is prevented.")},t.request.onsuccess=function(e){t.db=e.target.result,t.status=u(t.__proto__||Object.getPrototypeOf(t),"STATUS",n).INITED,t._pool.consume(),t.db.onerror=function(e){return o(e.target.error)}},t.request.onupgradeneeded=function(e){var t=e.target.result,o=t.createObjectStore("logs",{autoIncrement:!0});o.createIndex("namespace","namespace",{unique:!1}),o.createIndex("level","level",{unique:!1}),o.createIndex("descriptor","descriptor",{unique:!1}),o.createIndex("data","data",{unique:!1})}}catch(e){o("failed init, "+e.message)}}},{key:"get",value:function(e,n,r){try{if(t.status!==u(t.__proto__||Object.getPrototypeOf(t),"STATUS",this).INITED)return t._pool.push(function(){return t.get(e,n,r)});e=v.transTimeFormat(e),n=v.transTimeFormat(n);var a=t._getTransactionStore(IDBTransaction.READ_ONLY);if(!a)return r([]);if(a.getAll){var i=void 0,c=[];a.getAll().onsuccess=function(t){i=t.target.result;for(var o=0;o<i.length;o++)e&&i[o].time<e||n&&i[o].time>n||c.push(i[o]);r(c)}}else{var s=a.openCursor(),l=[];s.onsuccess=function(t){var o=t.target.result;if(o){if(e&&o.value.time<e||n&&o.value.time>n)return o.continue();l.push({time:o.value.time,level:o.value.level,namespace:o.value.namespace,descriptor:o.value.descriptor,data:o.value.data}),o.continue()}else r(l)}}}catch(e){o("failed to get logs, "+e.message)}}},{key:"keep",value:function(e){try{if(t.status!==u(t.__proto__||Object.getPrototypeOf(t),"STATUS",this).INITED)return t._pool.push(function(){return t.keep(e)});var n=t._getTransactionStore(IDBTransaction.READ_WRITE);if(!n)return!1;if(e){var r=Date.now()-24*(e||2)*3600*1e3,a=n.openCursor();a.onsuccess=function(e){var t=e.target.result;t&&t.value.time<r&&(n.delete(t.primaryKey),t.continue())},a.onerror=function(t){return o("unable to locate logs earlier than "+e+"d.")}}else{n.clear().onerror=function(e){return o(e.target.error)}}}catch(e){o("failed to keep logs, "+e.message)}}},{key:"clean",value:function(){try{if(t.status!==u(t.__proto__||Object.getPrototypeOf(t),"STATUS",this).INITED)return t._pool.push(function(){return t.clean()});t.db.close();var e=window.indexedDB.deleteDatabase(t._database);e.onerror=function(e){return o(e.target.error)},e.onsuccess=function(e){delete t.status,delete t.db}}catch(e){o("failed to cleanup logs, "+e.message)}}},{key:"_getTransactionStore",value:function(e){try{if(t.db){var n=t.db.transaction(["logs"],e||IDBTransaction.READ_WRITE);return n.onerror=function(e){return o(e.target.error)},n.objectStore("logs")}o("log database is not created or connections are closed, considering init it.")}catch(e){return o("failed to generate new transaction, "+e.message),!1}}},{key:"support",get:function(){var e=!!(window.indexedDB&&window.IDBTransaction&&window.IDBKeyRange);return e&&(window.IDBTransaction.READ_WRITE="readwrite",window.IDBTransaction.READ_ONLY="readonly"),e}}]),t}(v),b=function(e){function t(){var e;i(this,t);for(var o=arguments.length,n=Array(o),r=0;r<o;r++)n[r]=arguments[r];return f(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(n)))}return l(t,e),c(t,[{key:"_record",value:function(e,r,a){var i;try{i=window.localStorage.getItem(t._database)?JSON.parse(window.localStorage.getItem(t._database)):[],i.push([Date.now(),this._namespace,e,r,a]),n(this._namespace,e,r,a),window.localStorage.setItem(t._database,JSON.stringify(i))}catch(e){o("failed to write, "+e.message)}}}],[{key:"init",value:function(e){try{t.support||o("your platform does not support localstorage protocol."),t._database=e||"logline",window.localStorage.getItem(t._database)||window.localStorage.setItem(t._database,JSON.stringify([])),t.status=u(t.__proto__||Object.getPrototypeOf(t),"STATUS",this).INITED}catch(e){o("failed to init, "+e.message)}}},{key:"get",value:function(e,n,r){var a,i;try{for(a=JSON.parse(window.localStorage.getItem(t._database)),e=v.transTimeFormat(e),n=v.transTimeFormat(n),i=0;i<a.length;i++)e&&a[i][0]<e||n&&a[i][0]>n||(a[i]={time:a[i][0],namespace:a[i][1],level:a[i][2],descriptor:a[i][3],data:a[i][4]});r(a)}catch(e){o("failed to get, "+e.message),r([])}}},{key:"keep",value:function(e){var n;try{n=e?(window.localStorage.getItem(t._database)?JSON.parse(window.localStorage.getItem(t._database)):[]).filter(function(t){return t.time>=Date.now()-24*(e||2)*3600*1e3}):[],window.localStorage.setItem(t._database,JSON.stringify(n))}catch(e){o("failed to keep, "+e.message)}}},{key:"clean",value:function(){try{delete t.status,window.localStorage.removeItem(t._database)}catch(e){o("failed to clean, "+e.message)}}},{key:"support",get:function(){return"localStorage"in window}}]),t}(v),T=function(e){function t(){var e;i(this,t);for(var o=arguments.length,n=Array(o),r=0;r<o;r++)n[r]=arguments[r];return f(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(n)))}return l(t,e),c(t,[{key:"_record",value:function(e,r,a){var i=this;if(t.status!==v.STATUS.INITED)return t._pool.push(function(){return i._record(e,r,a)}),void(t.status!==v.STATUS.INITING&&t.init());try{n(this._namespace,e,r,a),t._db.transaction(function(t){t.executeSql("INSERT INTO logs (time, namespace, level, descriptor, data) VALUES(?, ?, ?, ? ,?)",[Date.now(),i._namespace,e,r,void 0===a||""===a?"":JSON.stringify(a)||""],function(){},function(e,t){o("write error, "+t.message)})})}catch(e){o("error inserting record, "+e.message)}}}],[{key:"init",value:function(e){var n=this;if(t.support||o(new Error("your platform does not support websql protocol.")),t.status)return!1;t._pool=t._pool||new h,t._database=e||"logline",t.status=u(t.__proto__||Object.getPrototypeOf(t),"STATUS",this).INITING;try{t._db=window.openDatabase(t._database,"1.0","cats loves logs",5085593.6),t._db.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS logs (time, namespace, level, descriptor, data)",[],function(){t.status=u(t.__proto__||Object.getPrototypeOf(t),"STATUS",n).INITED,t._pool.consume()},function(e,r){t.status=u(t.__proto__||Object.getPrototypeOf(t),"STATUS",n).FAILED,o("unable to create table, "+r.message)})})}catch(e){o("unable to init log database, "+e.message)}}},{key:"get",value:function(e,n,r){if(t.status!==u(t.__proto__||Object.getPrototypeOf(t),"STATUS",this).INITED)return t._pool.push(function(){return t.get(e,n,r)});e=v.transTimeFormat(e),n=v.transTimeFormat(n);try{t._db.transaction(function(t){t.executeSql("SELECT * FROM logs ORDER BY time DESC",[],function(t,o){for(var a,i,c=[],s=o.rows.length;--s>=0;)if(i=o.rows.item(s),!(e&&i.time<e||n&&i.time>n)){a=JSON.parse(JSON.stringify(i));try{a.data=JSON.parse(a.data)}catch(e){}c.push(a)}r(c)},function(e,t){o(t.message)})})}catch(e){o("unable to collect logs from database.")}}},{key:"keep",value:function(e){if(t.status!==u(t.__proto__||Object.getPrototypeOf(t),"STATUS",this).INITED)return t._pool.push(function(){return t.keep(e)});try{t._db.transaction(function(t){e?t.executeSql("DELETE FROM logs WHERE time < ?",[Date.now()-24*(e||2)*3600*1e3],function(){},function(e,t){o(t.message)}):t.executeSql("DELETE FROM logs",[],function(){},function(e,t){o(t.message)})})}catch(e){o("unable to clean logs from database.")}}},{key:"clean",value:function(){if(t.status!==u(t.__proto__||Object.getPrototypeOf(t),"STATUS",this).INITED)return void t._pool.push(function(){return t.clean()});try{t._db.transaction(function(e){e.executeSql("DROP TABLE logs",[],function(){delete t.status},function(e,t){o(t.message)})})}catch(e){o("unable to clean log database.")}}},{key:"support",get:function(){return"openDatabase"in window}}]),t}(v),w=function(){function e(t){if(i(this,e),!(this instanceof e))return new e(t);try{return e._checkProtocol(),new e._protocol(t)}catch(e){return new v(t)}}return c(e,null,[{key:"_initProtocol",value:function(t){e._protocol=t,e._protocol.init(e._database||"logline")}},{key:"_checkProtocol",value:function(){if(!e._protocol){for(var t=Object.keys(e.PROTOCOL),n=void 0;n=e.PROTOCOL[t.shift()];)if(n.support)return void e._initProtocol(n);o("protocols "+t.join(", ").toLowerCase()+" are not supported on this platform")}}},{key:"get",value:function(t,o,n){switch(e._checkProtocol(),arguments.length){case 1:n=t,t=void 0;break;case 2:n=o,o=void 0}e._protocol.get(t,o,n)}},{key:"all",value:function(t){e.get(t)}},{key:"keep",value:function(t){return e._checkProtocol(),e._protocol.keep(t),this}},{key:"clean",value:function(){return e._checkProtocol(),e._protocol.clean(),this}},{key:"using",value:function(t,n){return-1===[m,b,T].indexOf(t)&&o("specialfied protocol "+(t?t+" ":"")+"is not available"),e._protocol?this:(e.database(n||e._database),e._initProtocol(t),this)}},{key:"database",value:function(t){e._database=t}},{key:"config",get:function(){return _}}]),e}();return w.PROTOCOL={INDEXEDDB:m,LOCALSTORAGE:b,WEBSQL:T},w.INTERFACE=Object.freeze(v),w.env={verbose:!0},w});
//# sourceMappingURL=logline.min.js.map
