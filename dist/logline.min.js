/**
 * logline v1.0.4 (https://github.com/latel/logline#readme)
 * Copyright 2017, latel <latelx64@icloud.com>
 * MIT license
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Logline=e()}(this,function(){"use strict";function t(t){throw new Error("Logline: "+t)}var e=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},o=function(){function t(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,o,n){return o&&t(e.prototype,o),n&&t(e,n),e}}(),n=function t(e,o,n){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,o);if(void 0===r){var a=Object.getPrototypeOf(e);return null===a?void 0:t(a,o,n)}if("value"in r)return r.value;var i=r.get;if(void 0!==i)return i.call(n)},r=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},a=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},i=function(){function n(t){e(this,n),this._namesapce=t}return o(n,[{key:"_record",value:function(e,o,n){t("method _record is not implemented.")}},{key:"info",value:function(){for(var t=arguments.length,e=Array(t),o=0;o<t;o++)e[o]=arguments[o];this._record.apply(this,["info"].concat(e))}},{key:"warn",value:function(){for(var t=arguments.length,e=Array(t),o=0;o<t;o++)e[o]=arguments[o];this._record.apply(this,["warn"].concat(e))}},{key:"error",value:function(){for(var t=arguments.length,e=Array(t),o=0;o<t;o++)e[o]=arguments[o];this._record.apply(this,["error"].concat(e))}},{key:"critical",value:function(){for(var t=arguments.length,e=Array(t),o=0;o<t;o++)e[o]=arguments[o];this._record.apply(this,["critical"].concat(e))}}],[{key:"init",value:function(t){return!0}},{key:"transTimeFormat",value:function(t,e){if(!t||/^\d{13}$/.test(t))return+t;if(e&&!/^\d{13}$/.test(e))throw new TypeError("relative time should be standard unix timestamp");return(e||Date.now())-24*t.replace(/d$/,"")*3600*1e3}},{key:"get",value:function(e,o,n){t("method get is not implemented.")}},{key:"keep",value:function(e){t("method keep is not implemented.")}},{key:"clean",value:function(){t("method clean is not implemented.")}},{key:"STATUS",get:function(){return{INITING:1,INITED:2,FAILED:4}}}]),n}(),c=function(){function t(){e(this,t),this._pool=[]}return o(t,[{key:"push",value:function(t,e){t.context=e,this._pool.push(t)}},{key:"consume",value:function(){for(var t;t=this._pool.shift();)t.call(t.context)}}]),t}(),u=function(u){function s(){var t;e(this,s);for(var o=arguments.length,n=Array(o),r=0;r<o;r++)n[r]=arguments[r];return a(this,(t=s.__proto__||Object.getPrototypeOf(s)).call.apply(t,[this].concat(n)))}return r(s,u),o(s,[{key:"_record",value:function(e,o,n){var r=this;if(s.status!==i.STATUS.INITED)return s._pool.push(function(){r._record(e,o,n)}),void(s.status!==i.STATUS.INITING&&s.init());var a=s.db.transaction(["logs"],IDBTransaction.READ_WRITE||"readwrite");a.onerror=function(e){return t(e.target.error)};var c=a.objectStore("logs"),u=c.add({time:Date.now(),namespace:this._namesapce,descriptor:o,data:n});u.onerror=function(e){s.status=i.STATUS.FAILED,t(e.target.error)}}}],[{key:"init",value:function(e){var o=this;return s.support||t("your platform does not support indexeddb protocol."),!s.status&&(s._pool=s._pool||new c,s._database=e||"logline",s.status=n(s.__proto__||Object.getPrototypeOf(s),"STATUS",this).INITING,s.request=window.indexedDB.open(s._database),s.request.onerror=function(e){return t("protocol indexeddb is prevented.")},s.request.onsuccess=function(e){s.db=e.target.result,s.status=n(s.__proto__||Object.getPrototypeOf(s),"STATUS",o).INITED,s._pool.consume(),s.db.onerror=function(e){return t(e.target.error)}},void(s.request.onupgradeneeded=function(t){var e=t.target.result,o=e.createObjectStore("logs",{autoIncrement:!0});o.createIndex("namespace","namespace",{unique:!1}),o.createIndex("level","level",{unique:!1}),o.createIndex("descriptor","descriptor",{unique:!1}),o.createIndex("data","data",{unique:!1})}))}},{key:"get",value:function(e,o,r){if(s.status!==n(s.__proto__||Object.getPrototypeOf(s),"STATUS",this).INITED)return void s._pool.push(function(){s.get(e,o,r)});e=i.transTimeFormat(e),o=i.transTimeFormat(o);var a=s._getTransactionStore(IDBTransaction.READ_ONLY||"readonly"),c=a.openCursor(),u=[];c.onsuccess=function(t){var n=t.target.result;n?((e&&n.value.time<e||o&&n.value.time>o)&&n.continue(),u.push({time:n.value.time,namespace:n.value.namespace,descriptor:n.value.descriptor,data:n.value.data}),n.continue()):r(u)},c.onerror=function(e){return t("failed to literat on logs from database.")}}},{key:"keep",value:function(e){if(s.status!==n(s.__proto__||Object.getPrototypeOf(s),"STATUS",this).INITED)return void s._pool.push(function(){s.keep(e)});var o=s._getTransactionStore(IDBTransaction.READ_WRITE);if(e){var r=IDBKeyRange.upperBound(Date.now()-24*(e||2)*3600*1e3,!0),a=o.openCursor(r);a.onsuccess=function(t){var e=t.target.result;e&&(o.delete(e.primaryKey),e.continue())},a.onerror=function(o){return t("unable to locate logs earlier than "+e+"d.")}}else{o.clear().onerror=function(e){return t(e.target.error)}}}},{key:"clean",value:function(){if(s.status!==n(s.__proto__||Object.getPrototypeOf(s),"STATUS",this).INITED)return void s._pool.push(function(){s.clean()});s.db.close();var e=window.indexedDB.deleteDatabase(s._database);e.onerror=function(e){return t(e.target.error)},e.onsuccess=function(t){delete s.status,delete s.db}}},{key:"_getTransactionStore",value:function(e){if(s.db){var o=s.db.transaction(["logs"],e||IDBTransaction.READ_WRITE||"readwrite");return o.onerror=function(e){return t(e.target.error)},o.objectStore("logs")}t("log database is not created or connections is closed, considering init it.")}},{key:"support",get:function(){return!!(window.indexedDB&&window.IDBTransaction&&window.IDBKeyRange)}}]),s}(i),s=function(c){function u(){var t;e(this,u);for(var o=arguments.length,n=Array(o),r=0;r<o;r++)n[r]=arguments[r];return a(this,(t=u.__proto__||Object.getPrototypeOf(u)).call.apply(t,[this].concat(n)))}return r(u,c),o(u,[{key:"_record",value:function(e,o,n){var r=window.localStorage.getItem(u._database)?JSON.parse(window.localStorage.getItem(u._database)):[];r.push([Date.now(),this._namesapce,e,o,n]);try{window.localStorage.setItem(u._database,JSON.stringify(r))}catch(e){t("error inserting record")}}}],[{key:"init",value:function(e){u.support||t("your platform does not support localstorage protocol."),u._database=e||"logline",window.localStorage.getItem(u._database)||window.localStorage.setItem(u._database,JSON.stringify([])),u.status=n(u.__proto__||Object.getPrototypeOf(u),"STATUS",this).INITED}},{key:"get",value:function(t,e,o){var n,r=JSON.parse(window.localStorage.getItem(u._database));for(t=i.transTimeFormat(t),e=i.transTimeFormat(e),n=0;n<r.length;n++)t&&r[n][0]<t||e&&r[n][0]>e||(r[n]={time:r[n][0],namespace:r[n][1],level:r[n][2],descriptor:r[n][3],data:r[n][4]});o(r)}},{key:"keep",value:function(t){var e=t?(window.localStorage.getItem(u._database)?JSON.parse(window.localStorage.getItem(u._database)):[]).filter(function(e){return e.time>=Date.now()-24*(t||2)*3600*1e3}):[];window.localStorage.setItem(u._database,JSON.stringify(e))}},{key:"clean",value:function(){delete u.status,window.localStorage.removeItem(u._database)}},{key:"support",get:function(){return"localStorage"in window}}]),u}(i),l=function(u){function s(){var t;e(this,s);for(var o=arguments.length,n=Array(o),r=0;r<o;r++)n[r]=arguments[r];return a(this,(t=s.__proto__||Object.getPrototypeOf(s)).call.apply(t,[this].concat(n)))}return r(s,u),o(s,[{key:"_record",value:function(e,o,n){var r=this;if(s.status!==i.STATUS.INITED)return s._pool.push(function(){r._record(e,o,n)}),void(s.status!==i.STATUS.INITING&&s.init());try{s._db.transaction(function(t){t.executeSql("INSERT INTO logs (time, namespace, level, descriptor, data) VALUES(?, ?, ?, ? ,?)",[Date.now(),r._namesapce,e,o,void 0===n||""===n?"":JSON.stringify(n)||""],function(){},function(t,e){throw e.message})})}catch(e){t("error inserting record")}}}],[{key:"init",value:function(e){var o=this;if(s.support||t(new Error("your platform does not support websql protocol.")),s.status)return!1;s._pool=s._pool||new c,s._database=e||"logline",s.status=n(s.__proto__||Object.getPrototypeOf(s),"STATUS",this).INITING;try{s._db=window.openDatabase(s._database,"1.0","cats loves logs",5085593.6),s._db.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS logs (time, namespace, level, descriptor, data)",[],function(){s.status=n(s.__proto__||Object.getPrototypeOf(s),"STATUS",o).INITED,s._pool.consume()},function(){s.status=n(s.__proto__||Object.getPrototypeOf(s),"STATUS",o).FAILED})})}catch(e){t("unable to init log database.")}}},{key:"get",value:function(e,o,r){if(s.status!==n(s.__proto__||Object.getPrototypeOf(s),"STATUS",this).INITED)return void s._pool.push(function(){s.get(e,o,r)});e=i.transTimeFormat(e),o=i.transTimeFormat(o);try{s._db.transaction(function(t){t.executeSql("SELECT * FROM logs ORDER BY time DESC",[],function(t,n){for(var a,i,c=[],u=n.rows.length;--u>=0;)if(i=n.rows.item(u),!(e&&i.time<e||o&&i.time>o)){a=JSON.parse(JSON.stringify(i));try{a.data=JSON.parse(a.data)}catch(t){}c.push(a)}r(c)},function(t,e){throw e.message})})}catch(e){t("unable to collect logs from database.")}}},{key:"keep",value:function(e){if(s.status!==n(s.__proto__||Object.getPrototypeOf(s),"STATUS",this).INITED)return void s._pool.push(function(){s.keep(e)});try{s._db.transaction(function(t){e?t.executeSql("DELETE FROM logs WHERE time < ?",[Date.now()-24*(e||2)*3600*1e3],function(){},function(t,e){throw e.message}):t.executeSql("DELETE FROM logs",[],function(){},function(t,e){throw e.message})})}catch(e){t("unable to clean logs from database.")}}},{key:"clean",value:function(){if(s.status!==n(s.__proto__||Object.getPrototypeOf(s),"STATUS",this).INITED)return void s._pool.push(function(){s.clean()});try{s._db.transaction(function(t){t.executeSql("DROP TABLE logs",[],function(){delete s.status},function(t,e){throw e.message})})}catch(e){t("unable to clean log database.")}}},{key:"support",get:function(){return"openDatabase"in window}}]),s}(i),f=function(){function n(t){return e(this,n),n._checkProtocol(),new n._protocol(t)}return o(n,null,[{key:"_initProtocol",value:function(t){n._protocol=t,n._protocol.init(n._database||"logline")}},{key:"_checkProtocol",value:function(){if(!n._protocol){for(var t=Object.keys(n.PROTOCOL),e=void 0;e=n.PROTOCOL[t.shift()];)if(e.support)return void n._initProtocol(e);throw new Error(t.join(", ").toLowerCase()+" protocols are not supported on this platform")}}},{key:"get",value:function(t,e,o){Date.now();switch(n._checkProtocol(),arguments.length){case 1:o=t,t=void 0;break;case 2:o=e,e=void 0;break;case 3:}n._protocol.get(t,e,o)}},{key:"all",value:function(t){n.get(t)}},{key:"keep",value:function(t){return n._checkProtocol(),n._protocol.keep(t),this}},{key:"clean",value:function(){return n._checkProtocol(),n._protocol.clean(),this}},{key:"using",value:function(e,o){return-1===[u,s,l].indexOf(e)&&t("specialfied protocol "+(e?e+" ":"")+"is not available"),n._protocol?this:(n.database(o||n._database),n._initProtocol(e),this)}},{key:"database",value:function(t){n._database=t}}]),n}();return f.PROTOCOL={INDEXEDDB:u,LOCALSTORAGE:s,WEBSQL:l},f.INTERFACE=Object.freeze(i),f});
//# sourceMappingURL=logline.min.js.map
