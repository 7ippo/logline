/*!
 * logline v1.0.0 (https://github.com/latel/logline#readme)
 * Copyright 2016, latel <latelx64@gmail.com>
 * MIT license
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Logline=t():e.Logline=t()}(this,function(){return function(e){function t(o){if(r[o])return r[o].exports;var n=r[o]={exports:{},id:o,loaded:!1};return e[o].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}function n(e){return e&&e.__esModule?e:{"default":e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),c=r(1),u=n(c),l=r(4),s=n(l),f=r(5),p=n(f),d=r(3),y=o(d),h=function b(e){return b._checkProtocol(),new b._protocol(e)},w=function(){function e(t){return a(this,e),e._checkProtocol(),new e._protocol(t)}return i(e,null,[{key:"_checkProtocol",value:function(){e._protocol||y.throwError('you must choose a protocol with "using" method.')}},{key:"deploy",value:function(t,r,o,n){e._checkProtocol(),e._reportTo?e._protocol.all(function(e){var a,i,c,u=new XMLHttpRequest,l=[];for(u.upload.onprogress=r,u.onload=function(){200===u.status?"function"==typeof o&&o():"function"==typeof n&&n()},u.onerror=function(){"function"==typeof n&&n()},u.open("POST",h._reportTo),u.setRequestHeader("Content-Type","application/x-www-form-urlencoded");a=e.pop();){c=[];for(i in a)a.hasOwnProperty(i)&&a[i]&&c.push(a[i]);l.push(c.join("\t"))}u.withCredentials=!0,l.unshift(location.host+(t?": "+t:"")),u.send("data="+(escape(l.join("\n"))||"no data"))}):y.throwError("report address is not configed.")}},{key:"keep",value:function(t){try{e._checkProtocol(),e._protocol.keep(t)}catch(r){y.throwError("unable to remove logs earlier than "+t+"d.")}return this}},{key:"clean",value:function(){try{e._checkProtocol(),e._protocol.clean()}catch(t){y.throwError("unable to clean log database.")}return this}},{key:"using",value:function(t){return e._protocol?this:(-1<Object.values(e.PROTOCOL).indexOf(t)?(e._protocol=t,e.init()):y.throwError("specialfied protocol is not available."),this)}},{key:"init",value:function(){return e._checkProtocol(),e._protocol.init(),this}},{key:"reportTo",value:function(t){return e._reportTo=t,this}}]),e}();w._protocol=null,w._reportTo=null,w.PROTOCOL={WEBSQL:s["default"],LOCALSTORAGE:u["default"],INDEXEDDB:p["default"]},e.exports=w},function(e,t,r){"use strict";function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}function n(e){return e&&e.__esModule?e:{"default":e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function c(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),l=r(2),s=n(l),f=r(3),p=o(f),d=function(e){function t(){var e;a(this,t);for(var r=arguments.length,o=Array(r),n=0;n<r;n++)o[n]=arguments[n];return i(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(o)))}return c(t,e),u(t,[{key:"_record",value:function(e,t,r){var o=window.localStorage.getItem("logline")?JSON.parse(window.localStorage.getItem("logline")):[];o.push({time:Date.now(),namespace:this._namesapce,level:e,descriptor:t,data:r});try{window.localStorage.setItem("logline",JSON.stringify(o))}catch(n){p.throwError("error inserting record")}}}],[{key:"init",value:function(){"localStorage"in window||p.throwError("your platform does not support localstorage protocol."),window.localStorage.getItem("logline")||window.localStorage.setItem("logline",JSON.stringify([]))}},{key:"all",value:function(e){e(JSON.parse(window.localStorage.getItem("logline")))}},{key:"keep",value:function(e){var t=e?(window.localStorage.getItem("logline")?JSON.parse(window.localStorage.getItem("logline")):[]).filter(function(t){return t.time>=Date.now()-24*(e||2)*3600*1e3}):[];window.localStorage.setItem("logline",JSON.stringify(t))}},{key:"clean",value:function(){window.localStorage.removeItem("logline")}}]),t}(s["default"]);t["default"]=d},function(e,t,r){"use strict";function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),i=r(3),c=o(i),u=function(){function e(t){n(this,e),this._namesapce=t}return a(e,[{key:"_record",value:function(e,t,r){c.throwError("method _record is not implemented.")}},{key:"info",value:function(){this._record.apply(this,Array.prototype.unshift.call(arguments,"info")&&arguments)}},{key:"warn",value:function(){this._record.apply(this,Array.prototype.unshift.call(arguments,"warning")&&arguments)}},{key:"error",value:function(){this._record.apply(this,Array.prototype.unshift.call(arguments,"error")&&arguments)}},{key:"critical",value:function(){this._record.apply(this,Array.prototype.unshift.call(arguments,"critical")&&arguments)}}]),e}();t["default"]=u},function(e,t){"use strict";function r(e){throw new Error("Logline: "+e)}Object.defineProperty(t,"__esModule",{value:!0}),t.throwError=r},function(e,t,r){"use strict";function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}function n(e){return e&&e.__esModule?e:{"default":e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function c(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),l=r(2),s=n(l),f=r(3),p=o(f),d=function(e){function t(){var e;a(this,t);for(var r=arguments.length,o=Array(r),n=0;n<r;n++)o[n]=arguments[n];return i(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(o)))}return c(t,e),u(t,[{key:"_record",value:function(e,r,o,n){var a=this,i=arguments;if(!n||n<10)if(t._inited)try{t._db.transaction(function(t){t.executeSql("INSERT INTO logs (time, namespace, level, descriptor, data) VALUES(?, ?, ?, ? ,?)",[Date.now(),a._namesapce,e,r,void 0===o||""===o?"":JSON.stringify(o)||""],function(){},function(e,t){throw t})})}catch(c){p.throwError("error inserting record")}else setTimeout(function(){switch(i.length){case 2:Array.prototype.push.call(i,"",1);break;case 3:Array.prototype.push.call(i,1);break;case 4:Array.prototype.push.call(i=Array.prototype.slice.call(i,0,3),n+1)}a._record.apply(a,i)})}}],[{key:"init",value:function(){"openDatabase"in window||p.throwError(new Error("your platform does not support websql protocol."));try{t._db=window.openDatabase("logline","1.0","cats loves logs",5085593.6),t._db.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS logs (time, namespace, level, descriptor, data)",[],function(){t._inited=!0},function(){t._inited=!1})})}catch(e){p.throwError("unable to init log database.")}}},{key:"all",value:function(e){try{t._db.transaction(function(t){t.executeSql("SELECT * FROM logs",[],function(t,r){for(var o=[],n=r.rows.length;--n>=0;)o.push(r.rows.item(n));e(o)},function(e,t){throw t})})}catch(r){p.throwError("unable to collect logs from database.")}}},{key:"keep",value:function(e){try{t._db.transaction(function(t){e?t.executeSql("DELETE FROM logs WHERE time < ?",[Date.now()-24*(e||2)*3600*1e3],function(){},function(e,t){throw t}):t.executeSql("DELETE FROM logs",[],function(){},function(e,t){throw t})})}catch(r){p.throwError("unable to clean logs from database.")}}},{key:"clean",value:function(){try{t._db.transaction(function(e){e.executeSql("DROP TABLE logs",[],function(){},function(e,t){throw t})})}catch(e){p.throwError("unable to clean log database.")}}}]),t}(s["default"]);t["default"]=d},function(e,t,r){"use strict";function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}function n(e){return e&&e.__esModule?e:{"default":e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function c(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),l=r(2),s=n(l),f=r(3),p=o(f),d=function(e){function t(){var e;a(this,t);for(var r=arguments.length,o=Array(r),n=0;n<r;n++)o[n]=arguments[n];return i(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(o)))}return c(t,e),u(t,[{key:"_record",value:function(e,r,o){var n=t.db.transaction(["logs"],IDBTransaction.READ_WRITE||"readwrite");n.onerror=function(e){return p.throwError(e.target.errorCode)};var a=n.objectStore("logs"),i=a.add({timestamp:Date.now(),namespace:this._namesapce,descriptor:r,data:o});i.onerror=function(e){return p.throwError(e.target.errorCode)}}}],[{key:"init",value:function(){window.indexedDB&&window.IDBTransaction&&window.IDBKeyRange||p.throwError("your platform does not support indexeddb protocol."),t.request=window.indexedDB.open("logline"),t.request.onerror=function(e){return p.throwError("protocol indexeddb is prevented.")},t.request.onsuccess=function(e){t.db=e.target.result,t.db.onerror=function(e){return p.throwError(e.target.errorCode)}},t.request.onupgradeneeded=function(e){var t=e.target.result,r=t.createObjectStore("logs",{keyPath:"timestamp"});r.createIndex("namespace","namespace",{unique:!1}),r.createIndex("level","level",{unique:!1}),r.createIndex("descriptor","descriptor",{unique:!1}),r.createIndex("data","data",{unique:!1})}}},{key:"all",value:function(e){var r=t._getTransactionStore(IDBTransaction.READ_ONLY||"readonly"),o=r.openCursor(),n=[];o.onsuccess=function(t){var r=t.target.result;r?(n.push({timestamp:r.value.timestamp,namespace:r.value.namespace,descriptor:r.value.descriptor,data:r.value.data}),r["continue"]()):e(n)},o.onerror=function(e){return p.throwError("failed to literat on logs from database.")}}},{key:"keep",value:function(e){var r=t._getTransactionStore(IDBTransaction.READ_WRITE);if(e){var o=IDBKeyRange.upperBound(Date.now()-24*(e||2)*3600*1e3,!0),n=r.openCursor(o);n.onsuccess=function(e){var t=e.target.result;t&&(r["delete"](t.primaryKey),t["continue"]())},n.onerror=function(t){return p.throwError("unable to locate logs earlier than "+e+"d.")}}else{r.clear().onerror=function(e){return p.throwError(e.target.errorCode)}}}},{key:"clean",value:function(){t.db.close();var e=window.indexedDB.deleteDatabase("logline");e.onerror=function(e){return p.throwError(e.target.errorCode)},e.onsuccess=function(e){return delete t.db}}},{key:"_getTransactionStore",value:function(e){if(t.db){var r=t.db.transaction(["logs"],e||IDBTransaction.READ_WRITE||"readwrite");return r.onerror=function(e){return p.throwError(e.target.errorCode)},r.objectStore("logs")}p.throwError("log database is not created or connections is closed, cosidering init it.")}}]),t}(s["default"]);t["default"]=d}])});
//# sourceMappingURL=logline.map