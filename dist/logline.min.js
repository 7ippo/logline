/*!
 * logline v1.0.3 (https://github.com/latel/logline#readme)
 * Copyright 2016, latel <latelx64@gmail.com>
 * MIT license
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Logline=t():e.Logline=t()}(this,function(){return function(e){function t(o){if(r[o])return r[o].exports;var n=r[o]={exports:{},id:o,loaded:!1};return e[o].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}function n(e){return e&&e.__esModule?e:{"default":e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),i=r(1),c=n(i),l=r(5),s=n(l),f=r(6),p=n(f),d=r(3),_=o(d),y=function(){function e(t){return a(this,e),e._checkProtocol(),new e._protocol(t)}return u(e,null,[{key:"_initProtocol",value:function(t){e._protocol=t,e._protocol.init(e._database||"logline")}},{key:"_checkProtocol",value:function(){if(!e._protocol){for(var t=Object.keys(e.PROTOCOL),r=void 0;r=e.PROTOCOL[t.shift()];)if(r.support)return void e._initProtocol(r);throw new Error(t.join(", ").toLowerCase()+" protocols are not supported on this platform")}}},{key:"getAll",value:function(t){e._checkProtocol(),e._protocol.all(function(e){return t(e)})}},{key:"keep",value:function(t){return e._checkProtocol(),e._protocol.keep(t),this}},{key:"clean",value:function(){return e._checkProtocol(),e._protocol.clean(),this}},{key:"using",value:function(t,r){return-1===[c["default"],s["default"],p["default"]].indexOf(t)&&_.throwError("specialfied protocol "+(t?t+" ":"")+"is not available"),e._protocol?this:(e.database(r||e._database),e._initProtocol(t),this)}},{key:"database",value:function(t){e._database=t}}]),e}();y.PROTOCOL={INDEXEDDB:c["default"],WEBSQL:s["default"],LOCALSTORAGE:p["default"]},e.exports=y},function(e,t,r){"use strict";function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}function n(e){return e&&e.__esModule?e:{"default":e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var c=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),l=function b(e,t,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,t);if(void 0===o){var n=Object.getPrototypeOf(e);return null===n?void 0:b(n,t,r)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(r)},s=r(2),f=n(s),p=r(4),d=n(p),_=r(3),y=o(_),v=function(e){function t(){var e;a(this,t);for(var r=arguments.length,o=Array(r),n=0;n<r;n++)o[n]=arguments[n];return u(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(o)))}return i(t,e),c(t,[{key:"_record",value:function(e,r,o){var n=this;if(t.status!==f["default"].STATUS.INITED)return t._pool.push(function(){n._record(e,r,o)}),void(t.status!==f["default"].STATUS.INITING&&t.init());var a=t.db.transaction(["logs"],IDBTransaction.READ_WRITE||"readwrite");a.onerror=function(e){return y.throwError(e.target.error)};var u=a.objectStore("logs"),i=u.add({time:Date.now(),namespace:this._namesapce,descriptor:r,data:o});i.onerror=function(e){t.status=f["default"].STATUS.FAILED,y.throwError(e.target.error)}}}],[{key:"init",value:function(e){var r=this;return t.support||y.throwError("your platform does not support indexeddb protocol."),!t.status&&(t._pool=t._pool||new d["default"],t._database=e||"logline",t.status=l(t.__proto__||Object.getPrototypeOf(t),"STATUS",this).INITING,t.request=window.indexedDB.open(t._database),t.request.onerror=function(e){return y.throwError("protocol indexeddb is prevented.")},t.request.onsuccess=function(e){t.db=e.target.result,t.status=l(t.__proto__||Object.getPrototypeOf(t),"STATUS",r).INITED,t._pool.consume(),t.db.onerror=function(e){return y.throwError(e.target.error)}},void(t.request.onupgradeneeded=function(e){var t=e.target.result,r=t.createObjectStore("logs",{autoIncrement:!0});r.createIndex("namespace","namespace",{unique:!1}),r.createIndex("level","level",{unique:!1}),r.createIndex("descriptor","descriptor",{unique:!1}),r.createIndex("data","data",{unique:!1})}))}},{key:"all",value:function(e){if(t.status!==l(t.__proto__||Object.getPrototypeOf(t),"STATUS",this).INITED)return void t._pool.push(function(){t.all(e)});var r=t._getTransactionStore(IDBTransaction.READ_ONLY||"readonly"),o=r.openCursor(),n=[];o.onsuccess=function(t){var r=t.target.result;console&&console.log(r),r?(n.push({time:r.value.time,namespace:r.value.namespace,descriptor:r.value.descriptor,data:r.value.data}),r["continue"]()):e(n)},o.onerror=function(e){return y.throwError("failed to literat on logs from database.")}}},{key:"keep",value:function(e){if(t.status!==l(t.__proto__||Object.getPrototypeOf(t),"STATUS",this).INITED)return void t._pool.push(function(){t.keep(e)});var r=t._getTransactionStore(IDBTransaction.READ_WRITE);if(e){var o=IDBKeyRange.upperBound(Date.now()-24*(e||2)*3600*1e3,!0),n=r.openCursor(o);n.onsuccess=function(e){var t=e.target.result;t&&(r["delete"](t.primaryKey),t["continue"]())},n.onerror=function(t){return y.throwError("unable to locate logs earlier than "+e+"d.")}}else{r.clear().onerror=function(e){return y.throwError(e.target.error)}}}},{key:"clean",value:function(){if(t.status!==l(t.__proto__||Object.getPrototypeOf(t),"STATUS",this).INITED)return void t._pool.push(function(){t.clean()});t.db.close();var e=window.indexedDB.deleteDatabase(t._database);e.onerror=function(e){return y.throwError(e.target.error)},e.onsuccess=function(e){delete t.status,delete t.db}}},{key:"_getTransactionStore",value:function(e){if(t.db){var r=t.db.transaction(["logs"],e||IDBTransaction.READ_WRITE||"readwrite");return r.onerror=function(e){return y.throwError(e.target.error)},r.objectStore("logs")}y.throwError("log database is not created or connections is closed, considering init it.")}},{key:"support",get:function(){return!!(window.indexedDB&&window.IDBTransaction&&window.IDBKeyRange)}}]),t}(f["default"]);t["default"]=v},function(e,t,r){"use strict";function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),u=r(3),i=o(u),c=function(){function e(t){n(this,e),this._namesapce=t}return a(e,[{key:"_record",value:function(e,t,r){i.throwError("method _record is not implemented.")}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this._record.apply(this,["info"].concat(t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this._record.apply(this,["warn"].concat(t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this._record.apply(this,["error"].concat(t))}},{key:"critical",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this._record.apply(this,["critical"].concat(t))}}],[{key:"init",value:function(e){return!0}},{key:"all",value:function(e){e([])}},{key:"keep",value:function(e){return!0}},{key:"clean",value:function(){return!0}},{key:"STATUS",get:function(){return{INITING:1,INITED:2,FAILED:4}}}]),e}();t["default"]=c},function(e,t){"use strict";function r(e){throw new Error("Logline: "+e)}Object.defineProperty(t,"__esModule",{value:!0}),t.throwError=r},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),n=function(){function e(){r(this,e),this._pool=[]}return o(e,[{key:"push",value:function(e,t){e.context=t,this._pool.push(e)}},{key:"consume",value:function(){for(var e;e=this._pool.shift();)e.call(e.context)}}]),e}();t["default"]=n},function(e,t,r){"use strict";function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}function n(e){return e&&e.__esModule?e:{"default":e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var c=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),l=function b(e,t,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,t);if(void 0===o){var n=Object.getPrototypeOf(e);return null===n?void 0:b(n,t,r)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(r)},s=r(2),f=n(s),p=r(4),d=n(p),_=r(3),y=o(_),v=function(e){function t(){var e;a(this,t);for(var r=arguments.length,o=Array(r),n=0;n<r;n++)o[n]=arguments[n];return u(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(o)))}return i(t,e),c(t,[{key:"_record",value:function(e,r,o){var n=this;if(t.status!==f["default"].STATUS.INITED)return t._pool.push(function(){n._record(e,r,o)}),void(t.status!==f["default"].STATUS.INITING&&t.init());try{t._db.transaction(function(t){t.executeSql("INSERT INTO logs (time, namespace, level, descriptor, data) VALUES(?, ?, ?, ? ,?)",[Date.now(),n._namesapce,e,r,void 0===o||""===o?"":JSON.stringify(o)||""],function(){},function(e,t){throw t.message})})}catch(a){y.throwError("error inserting record")}}}],[{key:"init",value:function(e){var r=this;if(t.support||y.throwError(new Error("your platform does not support websql protocol.")),t.status)return!1;t._pool=t._pool||new d["default"],t._database=e||"logline",t.status=l(t.__proto__||Object.getPrototypeOf(t),"STATUS",this).INITING;try{t._db=window.openDatabase(t._database,"1.0","cats loves logs",5085593.6),t._db.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS logs (time, namespace, level, descriptor, data)",[],function(){t.status=l(t.__proto__||Object.getPrototypeOf(t),"STATUS",r).INITED,t._pool.consume()},function(){t.status=l(t.__proto__||Object.getPrototypeOf(t),"STATUS",r).FAILED})})}catch(o){y.throwError("unable to init log database.")}}},{key:"all",value:function(e){if(t.status!==l(t.__proto__||Object.getPrototypeOf(t),"STATUS",this).INITED)return void t._pool.push(function(){t.all(e)});try{t._db.transaction(function(t){t.executeSql("SELECT * FROM logs ORDER BY time DESC",[],function(t,r){for(var o,n=[],a=r.rows.length;--a>=0;)o=JSON.parse(JSON.stringify(r.rows.item(a))),o.data=JSON.parse(o.data),n.push(o);e(n)},function(e,t){throw t.message})})}catch(r){y.throwError("unable to collect logs from database.")}}},{key:"keep",value:function(e){if(t.status!==l(t.__proto__||Object.getPrototypeOf(t),"STATUS",this).INITED)return void t._pool.push(function(){t.keep(e)});try{t._db.transaction(function(t){e?t.executeSql("DELETE FROM logs WHERE time < ?",[Date.now()-24*(e||2)*3600*1e3],function(){},function(e,t){throw t.message}):t.executeSql("DELETE FROM logs",[],function(){},function(e,t){throw t.message})})}catch(r){y.throwError("unable to clean logs from database.")}}},{key:"clean",value:function(){if(t.status!==l(t.__proto__||Object.getPrototypeOf(t),"STATUS",this).INITED)return void t._pool.push(function(){t.clean()});try{t._db.transaction(function(e){e.executeSql("DROP TABLE logs",[],function(){delete t.status},function(e,t){throw t.message})})}catch(e){y.throwError("unable to clean log database.")}}},{key:"support",get:function(){return"openDatabase"in window}}]),t}(f["default"]);t["default"]=v},function(e,t,r){"use strict";function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}function n(e){return e&&e.__esModule?e:{"default":e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var c=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),l=function y(e,t,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,t);if(void 0===o){var n=Object.getPrototypeOf(e);return null===n?void 0:y(n,t,r)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(r)},s=r(2),f=n(s),p=r(3),d=o(p),_=function(e){function t(){var e;a(this,t);for(var r=arguments.length,o=Array(r),n=0;n<r;n++)o[n]=arguments[n];return u(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(o)))}return i(t,e),c(t,[{key:"_record",value:function(e,r,o){var n=window.localStorage.getItem(t._database)?JSON.parse(window.localStorage.getItem(t._database)):[];n.push([Date.now(),this._namesapce,e,r,o]);try{window.localStorage.setItem(t._database,JSON.stringify(n))}catch(a){d.throwError("error inserting record")}}}],[{key:"init",value:function(e){t.support||d.throwError("your platform does not support localstorage protocol."),t._database=e||"logline",window.localStorage.getItem(t._database)||window.localStorage.setItem(t._database,JSON.stringify([])),t.status=l(t.__proto__||Object.getPrototypeOf(t),"STATUS",this).INITED}},{key:"all",value:function(e){var r,o=JSON.parse(window.localStorage.getItem(t._database));for(r=0;r<o.length;r++)o[r]={time:o[r][0],namespace:o[r][1],level:o[r][2],descriptor:o[r][3],data:o[r][4]};e(o)}},{key:"keep",value:function(e){var r=e?(window.localStorage.getItem(t._database)?JSON.parse(window.localStorage.getItem(t._database)):[]).filter(function(t){return t.time>=Date.now()-24*(e||2)*3600*1e3}):[];window.localStorage.setItem(t._database,JSON.stringify(r))}},{key:"clean",value:function(){delete t.status,window.localStorage.removeItem(t._database)}},{key:"support",get:function(){return"localStorage"in window}}]),t}(f["default"]);t["default"]=_}])});
//# sourceMappingURL=logline.min.map