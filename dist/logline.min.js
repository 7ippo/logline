/*!
 * logline v1.0.2 (https://github.com/latel/logline#readme)
 * Copyright 2016, latel <latelx64@gmail.com>
 * MIT license
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Logline=e():t.Logline=e()}(this,function(){return function(t){function e(r){if(o[r])return o[r].exports;var n=o[r]={exports:{},id:r,loaded:!1};return t[r].call(n.exports,n,n.exports,e),n.loaded=!0,n.exports}var o={};return e.m=t,e.c=o,e.p="",e(0)}([function(t,e,o){"use strict";function r(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e["default"]=t,e}function n(t){return t&&t.__esModule?t:{"default":t}}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var i=function(){function t(t,e){for(var o=0;o<e.length;o++){var r=e[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,o,r){return o&&t(e.prototype,o),r&&t(e,r),e}}(),u=o(1),c=n(u),l=o(5),s=n(l),f=o(6),p=n(f),d=o(3),_=r(d),y=function(){function t(e){return a(this,t),t._checkProtocol(),new t._protocol(e)}return i(t,null,[{key:"_initProtocol",value:function(e){t._protocol=e,t._protocol.init(t._database||"logline")}},{key:"_checkProtocol",value:function(){if(!t._protocol){for(var e=Object.keys(t.PROTOCOL),o=void 0;o=t.PROTOCOL[e.shift()];)if(o.support)return void t._initProtocol(o);throw new Error(e.join(", ").toLowerCase()+" protocols are not supported on this platform")}}},{key:"getAll",value:function(e){t._checkProtocol(),t._protocol.all(function(t){return e(t)})}},{key:"keep",value:function(e){return t._checkProtocol(),t._protocol.keep(e),this}},{key:"clean",value:function(){return t._checkProtocol(),t._protocol.clean(),this}},{key:"using",value:function(e,o){return-1===[c["default"],s["default"],p["default"]].indexOf(e)&&_.throwError("specialfied protocol "+(e?e+" ":"")+"is not available"),t._protocol?this:(t.database(o||t._database),t._initProtocol(e),this)}},{key:"database",value:function(e){t._database=e}}]),t}();y.PROTOCOL={INDEXEDDB:c["default"],WEBSQL:s["default"],LOCALSTORAGE:p["default"]},t.exports=y},function(t,e,o){"use strict";function r(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e["default"]=t,e}function n(t){return t&&t.__esModule?t:{"default":t}}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function u(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var c=function(){function t(t,e){for(var o=0;o<e.length;o++){var r=e[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,o,r){return o&&t(e.prototype,o),r&&t(e,r),e}}(),l=function b(t,e,o){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,e);if(void 0===r){var n=Object.getPrototypeOf(t);return null===n?void 0:b(n,e,o)}if("value"in r)return r.value;var a=r.get;if(void 0!==a)return a.call(o)},s=o(2),f=n(s),p=o(4),d=n(p),_=o(3),y=r(_),v=function(t){function e(){var t;a(this,e);for(var o=arguments.length,r=Array(o),n=0;n<o;n++)r[n]=arguments[n];return i(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this].concat(r)))}return u(e,t),c(e,[{key:"_record",value:function(t,o,r){var n=this;if(e.status===f["default"].STATUS.INITING)return void e._pool.push(function(){n._record(t,o,r)});var a=e.db.transaction(["logs"],IDBTransaction.READ_WRITE||"readwrite");a.onerror=function(t){return y.throwError(t.target.errorCode)};var i=a.objectStore("logs"),u=i.add({timestamp:Date.now(),namespace:this._namesapce,descriptor:o,data:r});u.onerror=function(t){e.status=l(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"STATUS",n).FAILED,y.throwError(t.target.errorCode)}}}],[{key:"init",value:function(t){var o=this;e.support||y.throwError("your platform does not support indexeddb protocol."),e._pool=new d["default"],e._database=t||"logline",e.status=l(e.__proto__||Object.getPrototypeOf(e),"STATUS",this).INITING,e.request=window.indexedDB.open(t),e.request.onerror=function(t){return y.throwError("protocol indexeddb is prevented.")},e.request.onsuccess=function(t){e.db=t.target.result,e.status=l(e.__proto__||Object.getPrototypeOf(e),"STATUS",o).INITED,e._pool.consume(),e.db.onerror=function(t){return y.throwError(t.target.errorCode)}},e.request.onupgradeneeded=function(t){var e=t.target.result,o=e.createObjectStore("logs",{keyPath:"timestamp"});o.createIndex("namespace","namespace",{unique:!1}),o.createIndex("level","level",{unique:!1}),o.createIndex("descriptor","descriptor",{unique:!1}),o.createIndex("data","data",{unique:!1})}}},{key:"all",value:function(t){if(e.status===l(e.__proto__||Object.getPrototypeOf(e),"STATUS",this).INITING)return void e._pool.push(function(){e.all(t)});var o=e._getTransactionStore(IDBTransaction.READ_ONLY||"readonly"),r=o.openCursor(),n=[];r.onsuccess=function(e){var o=e.target.result;o?(n.push({timestamp:o.value.timestamp,namespace:o.value.namespace,descriptor:o.value.descriptor,data:o.value.data}),o["continue"]()):t(n)},r.onerror=function(t){return y.throwError("failed to literat on logs from database.")}}},{key:"keep",value:function(t){if(e.status===l(e.__proto__||Object.getPrototypeOf(e),"STATUS",this).INITING)return void e._pool.push(function(){e.keep(t)});var o=e._getTransactionStore(IDBTransaction.READ_WRITE);if(t){var r=IDBKeyRange.upperBound(Date.now()-24*(t||2)*3600*1e3,!0),n=o.openCursor(r);n.onsuccess=function(t){var e=t.target.result;e&&(o["delete"](e.primaryKey),e["continue"]())},n.onerror=function(e){return y.throwError("unable to locate logs earlier than "+t+"d.")}}else{o.clear().onerror=function(t){return y.throwError(t.target.errorCode)}}}},{key:"clean",value:function(){if(e.status===l(e.__proto__||Object.getPrototypeOf(e),"STATUS",this).INITING)return void e._pool.push(function(){e.clean()});e.db.close();var t=window.indexedDB.deleteDatabase(e._database);t.onerror=function(t){return y.throwError(t.target.errorCode)},t.onsuccess=function(t){delete e.status,delete e.db}}},{key:"_getTransactionStore",value:function(t){if(e.db){var o=e.db.transaction(["logs"],t||IDBTransaction.READ_WRITE||"readwrite");return o.onerror=function(t){return y.throwError(t.target.errorCode)},o.objectStore("logs")}y.throwError("log database is not created or connections is closed, considering init it.")}}]),e}(f["default"]);e["default"]=v,v.support=!!(window.indexedDB&&window.IDBTransaction&&window.IDBKeyRange)},function(t,e,o){"use strict";function r(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e["default"]=t,e}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(t,e){for(var o=0;o<e.length;o++){var r=e[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,o,r){return o&&t(e.prototype,o),r&&t(e,r),e}}(),i=o(3),u=r(i),c=function(){function t(e){n(this,t),this._namesapce=e}return a(t,[{key:"_record",value:function(t,e,o){u.throwError("method _record is not implemented.")}},{key:"info",value:function(){for(var t=arguments.length,e=Array(t),o=0;o<t;o++)e[o]=arguments[o];this._record.apply(this,["info"].concat(e))}},{key:"warn",value:function(){for(var t=arguments.length,e=Array(t),o=0;o<t;o++)e[o]=arguments[o];this._record.apply(this,["warn"].concat(e))}},{key:"error",value:function(){for(var t=arguments.length,e=Array(t),o=0;o<t;o++)e[o]=arguments[o];this._record.apply(this,["error"].concat(e))}},{key:"critical",value:function(){for(var t=arguments.length,e=Array(t),o=0;o<t;o++)e[o]=arguments[o];this._record.apply(this,["critical"].concat(e))}}],[{key:"init",value:function(t){t()}},{key:"all",value:function(t){t([])}},{key:"keep",value:function(){}},{key:"clean",value:function(){}},{key:"STATUS",get:function(){return{INITING:1,INITED:2,FAILED:4}}}]),t}();e["default"]=c},function(t,e){"use strict";function o(t){throw new Error("Logline: "+t)}Object.defineProperty(e,"__esModule",{value:!0}),e.throwError=o},function(t,e){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){for(var o=0;o<e.length;o++){var r=e[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,o,r){return o&&t(e.prototype,o),r&&t(e,r),e}}(),n=function(){function t(){o(this,t),this._pool=[]}return r(t,[{key:"push",value:function(t,e){t.context=e,this._pool.push(t)}},{key:"consume",value:function(){for(var t;t=this._pool.shift();)t.call(t.context)}}]),t}();e["default"]=n},function(t,e,o){"use strict";function r(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e["default"]=t,e}function n(t){return t&&t.__esModule?t:{"default":t}}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function u(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var c=function(){function t(t,e){for(var o=0;o<e.length;o++){var r=e[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,o,r){return o&&t(e.prototype,o),r&&t(e,r),e}}(),l=function b(t,e,o){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,e);if(void 0===r){var n=Object.getPrototypeOf(t);return null===n?void 0:b(n,e,o)}if("value"in r)return r.value;var a=r.get;if(void 0!==a)return a.call(o)},s=o(2),f=n(s),p=o(4),d=n(p),_=o(3),y=r(_),v=function(t){function e(){var t;a(this,e);for(var o=arguments.length,r=Array(o),n=0;n<o;n++)r[n]=arguments[n];return i(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this].concat(r)))}return u(e,t),c(e,[{key:"_record",value:function(t,o,r){var n=this;if(e.status===f["default"].STATUS.INITING)return void e._pool.push(function(){n._record(t,o,r)});try{e._db.transaction(function(e){e.executeSql("INSERT INTO logs (time, namespace, level, descriptor, data) VALUES(?, ?, ?, ? ,?)",[Date.now(),n._namesapce,t,o,void 0===r||""===r?"":JSON.stringify(r)||""],function(){},function(t,e){throw e})})}catch(a){y.throwError("error inserting record")}}}],[{key:"init",value:function(t){var o=this;e.support||y.throwError(new Error("your platform does not support websql protocol.")),e._pool=new d["default"],e._database=t||"logline",e.status=l(e.__proto__||Object.getPrototypeOf(e),"STATUS",this).INITING;try{e._db=window.openDatabase(e._database,"1.0","cats loves logs",5085593.6),e._db.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS logs (time, namespace, level, descriptor, data)",[],function(){e.status=l(e.__proto__||Object.getPrototypeOf(e),"STATUS",o).INITED,e._pool.consume()},function(){e.status=l(e.__proto__||Object.getPrototypeOf(e),"STATUS",o).FAILED})})}catch(r){y.throwError("unable to init log database.")}}},{key:"all",value:function(t){if(e.status===l(e.__proto__||Object.getPrototypeOf(e),"STATUS",this).INITING)return void e._pool.push(function(){e.all(t)});try{e._db.transaction(function(e){e.executeSql("SELECT * FROM logs",[],function(e,o){for(var r=[],n=o.rows.length;--n>=0;)r.push(o.rows.item(n));t(r)},function(t,e){throw e})})}catch(o){y.throwError("unable to collect logs from database.")}}},{key:"keep",value:function(t){if(e.status===l(e.__proto__||Object.getPrototypeOf(e),"STATUS",this).INITING)return void e._pool.push(function(){e.keep(t)});try{e._db.transaction(function(e){t?e.executeSql("DELETE FROM logs WHERE time < ?",[Date.now()-24*(t||2)*3600*1e3],function(){},function(t,e){throw e}):e.executeSql("DELETE FROM logs",[],function(){},function(t,e){throw e})})}catch(o){y.throwError("unable to clean logs from database.")}}},{key:"clean",value:function(){if(e.status===l(e.__proto__||Object.getPrototypeOf(e),"STATUS",this).INITING)return void e._pool.push(function(){e.clean()});try{e._db.transaction(function(t){t.executeSql("DROP TABLE logss",[],function(){delete e.status},function(t,e){throw e})})}catch(t){y.throwError("unable to clean log database.")}}}]),e}(f["default"]);e["default"]=v,v.support="openDatabase"in window},function(t,e,o){"use strict";function r(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e["default"]=t,e}function n(t){return t&&t.__esModule?t:{"default":t}}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function u(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var c=function(){function t(t,e){for(var o=0;o<e.length;o++){var r=e[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,o,r){return o&&t(e.prototype,o),r&&t(e,r),e}}(),l=function y(t,e,o){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,e);if(void 0===r){var n=Object.getPrototypeOf(t);return null===n?void 0:y(n,e,o)}if("value"in r)return r.value;var a=r.get;if(void 0!==a)return a.call(o)},s=o(2),f=n(s),p=o(3),d=r(p),_=function(t){function e(){var t;a(this,e);for(var o=arguments.length,r=Array(o),n=0;n<o;n++)r[n]=arguments[n];return i(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this].concat(r)))}return u(e,t),c(e,[{key:"_record",value:function(t,o,r){var n=window.localStorage.getItem(e._database)?JSON.parse(window.localStorage.getItem(e._database)):[];n.push({time:Date.now(),namespace:this._namesapce,level:t,descriptor:o,data:r});try{window.localStorage.setItem(e._database,JSON.stringify(n))}catch(a){d.throwError("error inserting record")}}}],[{key:"init",value:function(t){e.support||d.throwError("your platform does not support localstorage protocol."),e._database=t||"logline",window.localStorage.getItem(e._database)||window.localStorage.setItem(e._database,JSON.stringify([])),e.status=l(e.__proto__||Object.getPrototypeOf(e),"STATUS",this).INITED}},{key:"all",value:function(t){t(JSON.parse(window.localStorage.getItem(e._database)))}},{key:"keep",value:function(t){var o=t?(window.localStorage.getItem(e._database)?JSON.parse(window.localStorage.getItem(e._database)):[]).filter(function(e){return e.time>=Date.now()-24*(t||2)*3600*1e3}):[];window.localStorage.setItem(e._database,JSON.stringify(o))}},{key:"clean",value:function(){window.localStorage.removeItem(e._database)}}]),e}(f["default"]);e["default"]=_,f["default"].support="localStorage"in window}])});
//# sourceMappingURL=logline.min.map